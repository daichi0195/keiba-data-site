# 目的
・モデルが「何によって勝っているのか」を明確化する
・今後の特徴量追加／削減の判断材料を得る
・過学習・不安定要因・擬似リークの兆候を洗い出す

# 前提モデル仕様
・学習手法：LightGBM LambdaRank
・group：race_id（1レース1グループ）
・出力：レース内スコア → softmax → 勝率
・確率較正：Isotonic Regression
・購入判断：期待値（勝率 × 単勝オッズ） ≥ 閾値
・オッズキャップあり
・直近N走：5走
・Train / Validation / Test は時系列分割済み

# 検証対象データ
・Train / Validation / Test すべて
・特に「実際に購入したレース（EV≥閾値）」を重視する

# 実施してほしい分析（必須）

## ① モデル内部重要度の可視化
・gain importance
・split count
→ 上位20特徴量を一覧化

## ② SHAPによる大域的貢献度分析
・SHAP summary plot（全体）
・平均|SHAP| 上位20特徴量を表形式で提示

## ③ SHAP dependence plot（重点）
以下の特徴量について必ず実施：
・直近N走タイム偏差系（mean / max / trend）
・フォールバックレベル（条件粒度）
・騎手関連特徴量
・馬体重 / 枠 / 脚質（あれば）

→ 単調性・非連続性・逆方向効果の有無を確認

## ④ EV戦略寄与分析（最重要）
・「実際に購入されたレース（EV≥閾値）」のみを抽出
・そのサブセットで SHAP を再集計
・「その馬が選ばれた理由になった特徴量」を明確化

→ 精度向上には寄与しているが、
   EV判断には寄与していない特徴量を識別する

## ⑤ 危険信号の検出
以下の兆候があれば明示してください：
・ID的・代理的特徴量が上位に来ている
・フォールバック指標が過剰に効いている
・騎手・枠・馬体重などドリフトしやすい特徴量が支配的
・SHAP形状が不自然（ギザギザ／非直感的）

# 出力形式
・図（importance / SHAP）は可能な限り画像で
・重要な数値は表で整理
・最後に以下を必ず文章でまとめること

  1. モデルの「勝ち筋」は何か
  2. 削減候補の特徴量
  3. 強化すべき特徴量（安定化・精緻化）
  4. 現時点で特徴量追加を行うべきか否か（YES/NOと理由）

# 制約
・精度を上げるための提案は不要
・感想・一般論は不要
・事実と分析結果のみで結論を出すこと