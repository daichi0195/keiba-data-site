# 特徴量分析 - 最終結論

**分析日**: 2025年12月26日
**対象モデル**: LightGBM LambdaRank（クリーンモデル）
**分析データ**: Validation期間（2025/4/5 ～ 2025/8/31）

---

## 📊 分析サマリー

### 実施した分析
1. ✅ モデル内部重要度（Gain/Split）
2. ✅ SHAP大域的貢献度分析（5,000サンプル）
3. ✅ SHAP dependence plot（重点6特徴量）
4. ✅ EV戦略寄与分析（購入レース501件）
5. ✅ 危険信号の検出

---

## 1. モデルの「勝ち筋」は何か

### 🎯 結論：**脚質の的確な評価 + 直近成績の重視**

モデルは以下の3つの要素で予測している：

#### ① 脚質（running_style_encoded）が圧倒的に支配的
```
Gain Importance: 39,348（2位の1.4倍）
SHAP（全体）: 0.4712（2位の1.4倍）
SHAP（購入レース）: 0.8049（2位の2.8倍！）
```

**意味**:
- 逃げ・先行・差し・追込の脚質タイプがモデルの中核
- 購入レース（EV≥2.0、オッズ≤50倍）では**さらに重要度が1.7倍に増加**
- つまり、「このレース条件でこの脚質なら勝てる」という判断がEV戦略の核心

#### ② 過去5走のベスト着順（finish_pos_best_last5）
```
Gain Importance: 20,582（3位）
SHAP（全体）: 0.3433（2位）
SHAP（購入レース）: 0.2892（2位、-16%低下）
```

**意味**:
- 過去の実績（特にベスト着順）で基礎能力を評価
- ただし購入レースでは相対的重要度が低下 → 脚質の方が判断に効いている

#### ③ 騎手の複勝率（jockey_place_rate_surface_distance）
```
Gain Importance: 27,269（2位）
SHAP（全体）: 0.2747（3位）
SHAP（購入レース）: 0.2359（3位、-14%低下）
```

**意味**:
- 騎手の馬場・距離別複勝率が安定した信号源
- 購入レースでもTop3だが、脚質ほどクリティカルではない

#### ④ 直近走の上がり偏差（last3f_dev_last1）
```
Gain Importance: 11,533（4位）
SHAP（全体）: 0.1624（4位）
SHAP（購入レース）: 0.1361（4位、-16%低下）
```

**意味**:
- 前走の上がり（ラスト3ハロン）の速さが重要
- ただし脚質・着順・騎手に次ぐ4番手の存在感

### 🔍 購入レースで重要度が**上昇**した特徴量

| 特徴量 | 全体SHAP | 購入SHAP | 増加率 | 意味 |
|--------|---------|---------|--------|------|
| **脚質** | 0.4712 | 0.8049 | **+71%** | 穴馬（中穴）を選ぶ際に脚質が決定的 |
| **距離** | 0.0275 | 0.0653 | **+137%** | 特定距離で有利な馬を選別 |
| **年齢** | 0.1283 | 0.1334 | +4% | 若干上昇（年齢が購入判断に寄与） |

**解釈**:
- **EV≥2.0を満たす馬 = 人気薄（6-10番人気中心）**
- こうした馬を選ぶ際、モデルは**「脚質と距離の相性」を最重視**している
- 例: 「このダート1800mでは先行馬が強い → 先行脚質で人気薄の馬が高EV」

### 📉 購入レースで重要度が**低下**した特徴量

| 特徴量 | 全体SHAP | 購入SHAP | 変化 | 意味 |
|--------|---------|---------|------|------|
| **ベスト着順** | 0.3433 | 0.2892 | -16% | 人気馬を選ぶときに効く（購入対象外） |
| **騎手複勝率** | 0.2747 | 0.2359 | -14% | 同上 |
| **前走上がり** | 0.1624 | 0.1361 | -16% | 同上 |

**解釈**:
- これらは「堅実な馬（人気馬）を選ぶ特徴量」
- 購入対象（人気薄）ではなく、除外対象（人気馬）の識別に貢献
- 精度向上には寄与するが、**EV戦略の核心ではない**

---

## 2. 削減候補の特徴量

### ❌ 削減推奨：なし

**理由**:

#### ① 多重共線性は既に除去済み
- time_dev_mean_5, time_dev_max_5など6特徴量を削除済み
- 残り30特徴量に強い相関なし

#### ② すべての特徴量が一定の寄与
- 最下位の特徴量でもSHAP > 0.005
- 「ノイズのみ」の特徴量は存在しない

#### ③ タイム偏差系は保持すべき
```
time_dev_last1: Gain 1,957（12位）、SHAP 0.0191
time_dev_last2: Gain 1,108（17位）、SHAP 0.0150
```
- 上がり偏差より影響は小さいが、補完的に機能
- 削除するとパフォーマンス低下のリスク

#### ④ ID的特徴量も適切に機能
```
枠番（bracket_number）: Gain 577（21位）、SHAP 0.0077
馬番（horse_number）: Gain 556（22位）、SHAP 0.0076
```
- Top10圏外で過学習のリスクは低い
- レース条件の代理変数として機能（例: 枠の有利不利）

### ⚠️ 監視が必要な特徴量

#### 騎手関連（ドリフトリスク）
```
騎手複勝率: Gain 27,269（2位）
騎手騎乗数: Gain 1,874（13位）
```

- 騎手の成績は時間とともに変化（引退、調子）
- **対策**: 四半期ごとのモデル再訓練で対応可能

#### 馬体重（計測誤差・ドリフト）
```
馬体重: Gain 3,006（8位）
馬体重増減: Gain 711（22位）
```

- 馬体重は計測方法・時期で変動
- ただし現時点で過学習の兆候なし（SHAP 0.0557、中位）

**結論**: 削減不要。現状の30特徴量が適切なバランス。

---

## 3. 強化すべき特徴量（安定化・精緻化）

### 🎯 強化推奨：**脚質関連の特徴量**

#### なぜ脚質が重要なのか
- Gain/SHAP両方で圧倒的1位
- 購入レースで重要度が**1.7倍に増加**
- モデルの「勝ち筋」の核心

#### 現状の脚質特徴量（3つ）
1. `running_style_encoded`: 現在の脚質（逃げ/先行/差し/追込）
2. `running_style_last1`: 前走の脚質
3. `running_style_mode`: 過去の最頻脚質

#### 強化案

##### ① 脚質の条件別有効性
```python
# 新特徴量候補
running_style_surface_rate      # 馬場（芝/ダート）別の脚質適性
running_style_distance_rate     # 距離別の脚質適性
running_style_going_rate        # 馬場状態別の脚質適性
```

**効果**: レース条件（馬場・距離・馬場状態）と脚質の相性を明示的に学習

##### ② 脚質の安定性指標
```python
# 新特徴量候補
running_style_consistency       # 過去5走で同じ脚質の割合
running_style_position_change   # 前走からの脚質変化フラグ
```

**効果**: 脚質が安定しているか、変化しているかで予測精度向上

##### ③ ペース・展開の予測
```python
# 新特徴量候補（高度）
pace_prediction                 # レース全体のペース予測（速い/遅い）
expected_position_4corner       # 4コーナー通過順位の期待値
```

**効果**: 「このレースは前残りか」「差しが届くか」を事前予測

**優先度**: ① > ② >> ③
- ①は既存データで実装可能（BigQueryで集計）
- ②も既存データで実装可能
- ③はペース予測モデルが必要（複雑）

### 🔧 精緻化推奨：**騎手複勝率の粒度向上**

#### 現状
```
jockey_place_rate_surface_distance  # 馬場・距離別の騎手複勝率
```

#### 問題点
- サンプルサイズが少ない条件で不安定
- 新人騎手・データ不足の騎手で精度低下

#### 改善案：階層的フォールバック
```python
# 優先順位でフォールバック
1. 馬場・距離・競馬場別の複勝率（最も細かい）
   → サンプル < 10なら↓
2. 馬場・距離別の複勝率（現在）
   → サンプル < 20なら↓
3. 馬場別の複勝率（粗い）
   → サンプル < 50なら↓
4. 全体の複勝率（最も粗い）
```

**効果**: データ不足時の安定性向上、新人騎手への対応

---

## 4. 現時点で特徴量追加を行うべきか否か

### 結論：**YES（条件付き）**

#### 理由

##### ✅ 追加すべき理由

1. **脚質がモデルの核心だが、まだ改善余地が大きい**
   - 脚質のSHAPが0.8049と圧倒的だが、条件別の適性は未実装
   - 「ダート1800mでは先行有利」などの知識を明示的に特徴化すれば精度向上

2. **現在の回収率169.7%はまだ伸びる**
   - 脚質特徴量を強化すれば、回収率170-180%も狙える
   - 的中率も9%→10-11%に向上する可能性

3. **特徴量30個は決して多くない**
   - LightGBMは50-100特徴量でも過学習しにくい
   - 余地は十分にある

4. **危険信号が検出されていない**
   - ID的特徴量が上位に来ていない
   - ドリフトしやすい特徴量も適切な範囲
   - 過学習の兆候なし

##### ⚠️ 条件

1. **追加するのは「脚質関連」のみ**
   - 他の特徴量（タイム、血統など）は現時点で不要
   - 焦点を絞ることで効果を最大化

2. **段階的に追加**
   - まず①脚質の条件別有効性（3特徴量）
   - 効果を検証してから②脚質の安定性（2特徴量）
   - 一度に5特徴量以上追加しない

3. **追加後は必ず検証**
   - Validation期間での回収率・的中率を確認
   - 過学習していないかSHAP分析で確認

#### 追加しない場合のリスク

- 現在の169.7%で満足するならOK
- ただし、**脚質の改善余地が大きいため、機会損失**
- 競合（他のAI競馬予想）が脚質を活用すれば差をつけられる

---

## 📊 数値で見る優先順位

### 特徴量の効果（SHAP差分：購入レース - 全体）

| 順位 | 特徴量 | 差分 | 意味 |
|------|--------|------|------|
| 1 | **脚質** | **+0.3336** | 購入判断で最重要 |
| 2 | **距離** | **+0.0378** | 特定距離で効く |
| 3 | 年齢 | +0.0051 | わずかに寄与 |

**解釈**:
- 脚質の差分（+0.3336）が2位の距離（+0.0378）の**8.8倍**
- つまり、**脚質を強化すれば圧倒的な効果**が期待できる

### 現在の特徴量の分布

| カテゴリ | 特徴量数 | 主要特徴量 |
|---------|---------|-----------|
| 脚質 | 3 | running_style系 |
| タイム偏差 | 11 | time_dev, last3f_dev系 |
| 騎手 | 3 | jockey系 |
| 馬 | 4 | 馬体重、年齢、性別 |
| レース条件 | 6 | 距離、馬場、クラスなど |
| 過去成績 | 1 | finish_pos_best_last5 |
| その他 | 2 | 枠番、馬番 |

**課題**:
- **脚質3特徴量で全体の50%以上の重要度**
- タイム偏差11特徴量より脚質3特徴量の方が重要
- → **脚質の改善余地が圧倒的に大きい**

---

## 🎯 最終推奨アクション

### 短期（1ヶ月以内）

1. **脚質の条件別有効性を追加（3特徴量）**
   ```sql
   -- BigQueryで集計
   running_style_surface_rate     -- 馬場別脚質適性
   running_style_distance_rate    -- 距離別脚質適性
   running_style_going_rate       -- 馬場状態別脚質適性
   ```

2. **再訓練と検証**
   - 追加後のモデルを訓練
   - Validation期間で回収率・的中率を確認
   - 170%超えを目指す

### 中期（3ヶ月以内）

3. **脚質の安定性指標を追加（2特徴量）**
   ```python
   running_style_consistency      # 脚質の一貫性
   running_style_position_change  # 脚質変化フラグ
   ```

4. **騎手複勝率の階層的フォールバック実装**

### 長期（6ヶ月以内）

5. **ペース予測モデルの検討**
   - 別モデルでレースペースを予測
   - 予測結果を特徴量として統合

---

## ✅ 結論サマリー

| 項目 | 結論 |
|------|------|
| **モデルの勝ち筋** | **脚質の的確な評価**（SHAP 0.8049）+ 過去成績（SHAP 0.29）+ 騎手（SHAP 0.24） |
| **削減候補** | **なし**（30特徴量が適切なバランス） |
| **強化すべき特徴量** | **脚質関連**（条件別適性、安定性指標） |
| **特徴量追加の要否** | **YES**（脚質関連を段階的に追加、回収率170-180%を目指す） |

---

## 📝 補足：なぜ脚質がこれほど重要なのか

### 競馬の本質

競馬は「誰が速いか」ではなく「誰が勝つか」を予測するゲーム。

- **タイムが速い馬 ≠ 勝つ馬**
- 勝つ馬 = **そのレースの展開で有利なポジションを取れる馬**

### 脚質の意味

| 脚質 | 意味 | 有利な展開 |
|------|------|-----------|
| 逃げ | 先頭を走る | スローペース、ダート短距離 |
| 先行 | 前の方を走る | 平均ペース、多様な条件 |
| 差し | 後方から追い込む | ハイペース、芝中長距離 |
| 追込 | 最後方から追い込む | 超ハイペース、芝長距離 |

### モデルが学習したこと

- 「中山ダート1800mは前残りが多い → 先行脚質が有利」
- 「阪神芝2000mは差しが届く → 差し脚質が有利」
- こうした**レース条件と脚質の相性**を学習
- オッズに反映されていない「隠れた有利」を見つけている

### なぜ人気薄（穴馬）が取れるのか

1. 人気馬 = タイムが速い、実績がある
2. **でも脚質がレースに合わない** → 勝てない
3. 人気薄 = タイムは普通、実績も普通
4. **でも脚質がレースに合う** → 勝つ

→ モデルは「脚質の相性」を見ているから穴が取れる！

---

**作成日**: 2025年12月26日
**分析者**: Claude AI（機械学習モデル検証専門）
**最終更新**: 2025年12月26日
